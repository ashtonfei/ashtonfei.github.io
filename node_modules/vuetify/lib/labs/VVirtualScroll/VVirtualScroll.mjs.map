{"version":3,"file":"VVirtualScroll.mjs","names":["VVirtualScrollItem","makeDimensionProps","useDimension","useDisplay","useResizeObserver","computed","onMounted","ref","watch","watchEffect","clamp","convertToUnit","createRange","genericComponent","useRender","UP","DOWN","VVirtualScroll","name","props","items","type","Array","default","itemHeight","Number","String","visibleItems","setup","_ref","slots","first","baseItemHeight","get","parseInt","value","set","val","rootEl","resizeRef","contentRect","display","sizeMap","Map","sizes","length","map","Math","max","ceil","height","handleItemResize","index","calculateOffset","slice","reduce","curr","calculateMidPointIndex","scrollTop","start","end","middle","floor","middleOffset","lastScrollTop","handleScroll","direction","midPointIndex","buffer","round","scrollToIndex","offset","last","min","computedItems","paddingTop","paddingBottom","dimensionStyles","forEach","item","indexOf","delete","_createVNode"],"sources":["../../../src/labs/VVirtualScroll/VVirtualScroll.tsx"],"sourcesContent":["// Styles\nimport './VVirtualScroll.sass'\n\n// Components\nimport { VVirtualScrollItem } from './VVirtualScrollItem'\n\n// Composables\nimport { makeDimensionProps, useDimension } from '@/composables/dimensions'\nimport { useDisplay } from '@/composables/display'\nimport { useResizeObserver } from '@/composables/resizeObserver'\n\n// Utilities\nimport { computed, onMounted, ref, watch, watchEffect } from 'vue'\nimport {\n  clamp,\n  convertToUnit,\n  createRange,\n  genericComponent,\n  useRender,\n} from '@/util'\n\n// Types\nimport type { SlotsToProps } from '@/util'\n\nconst UP = -1\nconst DOWN = 1\n\nexport interface VVirtualScrollSlot<T> {\n  item: T\n  index: number\n}\n\nexport const VVirtualScroll = genericComponent<new <T>() => {\n  $props: {\n    items: readonly T[]\n  } & SlotsToProps<{\n    default: [VVirtualScrollSlot<T>]\n  }>\n}>()({\n  name: 'VVirtualScroll',\n\n  props: {\n    items: {\n      type: Array,\n      default: () => ([]),\n    },\n    itemHeight: [Number, String],\n    visibleItems: [Number, String],\n\n    ...makeDimensionProps(),\n  },\n\n  setup (props, { slots }) {\n    const first = ref(0)\n    const baseItemHeight = ref(props.itemHeight)\n    const itemHeight = computed({\n      get: () => parseInt(baseItemHeight.value ?? 0, 10),\n      set (val) {\n        baseItemHeight.value = val\n      },\n    })\n    const rootEl = ref<HTMLDivElement>()\n    const { resizeRef, contentRect } = useResizeObserver()\n    watchEffect(() => {\n      resizeRef.value = rootEl.value\n    })\n    const display = useDisplay()\n\n    const sizeMap = new Map<any, number>()\n    let sizes = createRange(props.items.length).map(() => itemHeight.value)\n    const visibleItems = computed(() => {\n      return props.visibleItems\n        ? parseInt(props.visibleItems, 10)\n        : Math.max(12,\n          Math.ceil(((contentRect.value?.height ?? display.height.value) / itemHeight.value) * 1.7 + 1)\n        )\n    })\n\n    function handleItemResize (index: number, height: number) {\n      itemHeight.value = Math.max(itemHeight.value, height)\n      sizes[index] = height\n      sizeMap.set(props.items[index], height)\n    }\n\n    function calculateOffset (index: number) {\n      return sizes.slice(0, index).reduce((curr, value) => curr + (value || itemHeight.value), 0)\n    }\n\n    function calculateMidPointIndex (scrollTop: number) {\n      let start = 0\n      let end = props.items.length\n\n      while (start <= end) {\n        const middle = start + Math.floor((end - start) / 2)\n        const middleOffset = calculateOffset(middle)\n\n        if (middleOffset === scrollTop) {\n          return middle\n        } else if (middleOffset < scrollTop) {\n          start = middle + 1\n        } else if (middleOffset > scrollTop) {\n          end = middle - 1\n        }\n      }\n\n      return start\n    }\n\n    let lastScrollTop = 0\n    function handleScroll () {\n      if (!rootEl.value || !contentRect.value) return\n\n      const height = contentRect.value.height\n      const scrollTop = rootEl.value.scrollTop\n      const direction = scrollTop < lastScrollTop ? UP : DOWN\n\n      const midPointIndex = calculateMidPointIndex(scrollTop + height / 2)\n      const buffer = Math.round(visibleItems.value / 3)\n      if (direction === UP && midPointIndex <= first.value + (buffer * 2) - 1) {\n        first.value = clamp(midPointIndex - buffer, 0, props.items.length)\n      } else if (direction === DOWN && midPointIndex >= first.value + (buffer * 2) - 1) {\n        first.value = clamp(midPointIndex - buffer, 0, props.items.length - visibleItems.value)\n      }\n\n      lastScrollTop = rootEl.value.scrollTop\n    }\n\n    function scrollToIndex (index: number) {\n      if (!rootEl.value) return\n\n      const offset = calculateOffset(index)\n      rootEl.value.scrollTop = offset\n    }\n\n    const last = computed(() => Math.min(props.items.length, first.value + visibleItems.value))\n    const computedItems = computed(() => props.items.slice(first.value, last.value))\n    const paddingTop = computed(() => calculateOffset(first.value))\n    const paddingBottom = computed(() => calculateOffset(props.items.length) - calculateOffset(last.value))\n\n    const { dimensionStyles } = useDimension(props)\n\n    onMounted(() => {\n      if (!itemHeight.value) {\n        // If itemHeight prop is not set, then calculate an estimated height from the average of inital items\n        itemHeight.value = sizes.slice(first.value, last.value).reduce((curr, height) => curr + height, 0) / (visibleItems.value)\n      }\n    })\n\n    watch(() => props.items.length, () => {\n      sizes = createRange(props.items.length).map(() => itemHeight.value)\n      sizeMap.forEach((height, item) => {\n        const index = props.items.indexOf(item)\n        if (index === -1) {\n          sizeMap.delete(item)\n        } else {\n          sizes[index] = height\n        }\n      })\n    })\n\n    useRender(() => (\n      <div\n        ref={ rootEl }\n        class=\"v-virtual-scroll\"\n        onScroll={ handleScroll }\n        style={ dimensionStyles.value }\n      >\n        <div\n          class=\"v-virtual-scroll__container\"\n          style={{\n            paddingTop: convertToUnit(paddingTop.value),\n            paddingBottom: convertToUnit(paddingBottom.value),\n          }}\n        >\n          { computedItems.value.map((item, index) => (\n            <VVirtualScrollItem\n              key={ index }\n              dynamicHeight={ !props.itemHeight }\n              onUpdate:height={ height => handleItemResize(index + first.value, height) }\n            >\n              { slots.default?.({ item, index: index + first.value }) }\n            </VVirtualScrollItem>\n          ))}\n        </div>\n      </div>\n    ))\n\n    return {\n      scrollToIndex,\n    }\n  },\n})\n\nexport type VVirtualScroll = InstanceType<typeof VVirtualScroll>\n"],"mappings":";AAAA;AACA;;AAEA;AAAA,SACSA,kBAAkB,oCAE3B;AAAA,SACSC,kBAAkB,EAAEC,YAAY;AAAA,SAChCC,UAAU;AAAA,SACVC,iBAAiB,gDAE1B;AACA,SAASC,QAAQ,EAAEC,SAAS,EAAEC,GAAG,EAAEC,KAAK,EAAEC,WAAW,QAAQ,KAAK;AAAA,SAEhEC,KAAK,EACLC,aAAa,EACbC,WAAW,EACXC,gBAAgB,EAChBC,SAAS,gCAGX;AAGA,MAAMC,EAAE,GAAG,CAAC,CAAC;AACb,MAAMC,IAAI,GAAG,CAAC;AAOd,OAAO,MAAMC,cAAc,GAAGJ,gBAAgB,EAM1C,CAAC;EACHK,IAAI,EAAE,gBAAgB;EAEtBC,KAAK,EAAE;IACLC,KAAK,EAAE;MACLC,IAAI,EAAEC,KAAK;MACXC,OAAO,EAAEA,CAAA,KAAO;IAClB,CAAC;IACDC,UAAU,EAAE,CAACC,MAAM,EAAEC,MAAM,CAAC;IAC5BC,YAAY,EAAE,CAACF,MAAM,EAAEC,MAAM,CAAC;IAE9B,GAAGzB,kBAAkB;EACvB,CAAC;EAED2B,KAAKA,CAAET,KAAK,EAAAU,IAAA,EAAa;IAAA,IAAX;MAAEC;IAAM,CAAC,GAAAD,IAAA;IACrB,MAAME,KAAK,GAAGxB,GAAG,CAAC,CAAC,CAAC;IACpB,MAAMyB,cAAc,GAAGzB,GAAG,CAACY,KAAK,CAACK,UAAU,CAAC;IAC5C,MAAMA,UAAU,GAAGnB,QAAQ,CAAC;MAC1B4B,GAAG,EAAEA,CAAA,KAAMC,QAAQ,CAACF,cAAc,CAACG,KAAK,IAAI,CAAC,EAAE,EAAE,CAAC;MAClDC,GAAGA,CAAEC,GAAG,EAAE;QACRL,cAAc,CAACG,KAAK,GAAGE,GAAG;MAC5B;IACF,CAAC,CAAC;IACF,MAAMC,MAAM,GAAG/B,GAAG,EAAkB;IACpC,MAAM;MAAEgC,SAAS;MAAEC;IAAY,CAAC,GAAGpC,iBAAiB,EAAE;IACtDK,WAAW,CAAC,MAAM;MAChB8B,SAAS,CAACJ,KAAK,GAAGG,MAAM,CAACH,KAAK;IAChC,CAAC,CAAC;IACF,MAAMM,OAAO,GAAGtC,UAAU,EAAE;IAE5B,MAAMuC,OAAO,GAAG,IAAIC,GAAG,EAAe;IACtC,IAAIC,KAAK,GAAGhC,WAAW,CAACO,KAAK,CAACC,KAAK,CAACyB,MAAM,CAAC,CAACC,GAAG,CAAC,MAAMtB,UAAU,CAACW,KAAK,CAAC;IACvE,MAAMR,YAAY,GAAGtB,QAAQ,CAAC,MAAM;MAClC,OAAOc,KAAK,CAACQ,YAAY,GACrBO,QAAQ,CAACf,KAAK,CAACQ,YAAY,EAAE,EAAE,CAAC,GAChCoB,IAAI,CAACC,GAAG,CAAC,EAAE,EACXD,IAAI,CAACE,IAAI,CAAE,CAACT,WAAW,CAACL,KAAK,EAAEe,MAAM,IAAIT,OAAO,CAACS,MAAM,CAACf,KAAK,IAAIX,UAAU,CAACW,KAAK,GAAI,GAAG,GAAG,CAAC,CAAC,CAC9F;IACL,CAAC,CAAC;IAEF,SAASgB,gBAAgBA,CAAEC,KAAa,EAAEF,MAAc,EAAE;MACxD1B,UAAU,CAACW,KAAK,GAAGY,IAAI,CAACC,GAAG,CAACxB,UAAU,CAACW,KAAK,EAAEe,MAAM,CAAC;MACrDN,KAAK,CAACQ,KAAK,CAAC,GAAGF,MAAM;MACrBR,OAAO,CAACN,GAAG,CAACjB,KAAK,CAACC,KAAK,CAACgC,KAAK,CAAC,EAAEF,MAAM,CAAC;IACzC;IAEA,SAASG,eAAeA,CAAED,KAAa,EAAE;MACvC,OAAOR,KAAK,CAACU,KAAK,CAAC,CAAC,EAAEF,KAAK,CAAC,CAACG,MAAM,CAAC,CAACC,IAAI,EAAErB,KAAK,KAAKqB,IAAI,IAAIrB,KAAK,IAAIX,UAAU,CAACW,KAAK,CAAC,EAAE,CAAC,CAAC;IAC7F;IAEA,SAASsB,sBAAsBA,CAAEC,SAAiB,EAAE;MAClD,IAAIC,KAAK,GAAG,CAAC;MACb,IAAIC,GAAG,GAAGzC,KAAK,CAACC,KAAK,CAACyB,MAAM;MAE5B,OAAOc,KAAK,IAAIC,GAAG,EAAE;QACnB,MAAMC,MAAM,GAAGF,KAAK,GAAGZ,IAAI,CAACe,KAAK,CAAC,CAACF,GAAG,GAAGD,KAAK,IAAI,CAAC,CAAC;QACpD,MAAMI,YAAY,GAAGV,eAAe,CAACQ,MAAM,CAAC;QAE5C,IAAIE,YAAY,KAAKL,SAAS,EAAE;UAC9B,OAAOG,MAAM;QACf,CAAC,MAAM,IAAIE,YAAY,GAAGL,SAAS,EAAE;UACnCC,KAAK,GAAGE,MAAM,GAAG,CAAC;QACpB,CAAC,MAAM,IAAIE,YAAY,GAAGL,SAAS,EAAE;UACnCE,GAAG,GAAGC,MAAM,GAAG,CAAC;QAClB;MACF;MAEA,OAAOF,KAAK;IACd;IAEA,IAAIK,aAAa,GAAG,CAAC;IACrB,SAASC,YAAYA,CAAA,EAAI;MACvB,IAAI,CAAC3B,MAAM,CAACH,KAAK,IAAI,CAACK,WAAW,CAACL,KAAK,EAAE;MAEzC,MAAMe,MAAM,GAAGV,WAAW,CAACL,KAAK,CAACe,MAAM;MACvC,MAAMQ,SAAS,GAAGpB,MAAM,CAACH,KAAK,CAACuB,SAAS;MACxC,MAAMQ,SAAS,GAAGR,SAAS,GAAGM,aAAa,GAAGjD,EAAE,GAAGC,IAAI;MAEvD,MAAMmD,aAAa,GAAGV,sBAAsB,CAACC,SAAS,GAAGR,MAAM,GAAG,CAAC,CAAC;MACpE,MAAMkB,MAAM,GAAGrB,IAAI,CAACsB,KAAK,CAAC1C,YAAY,CAACQ,KAAK,GAAG,CAAC,CAAC;MACjD,IAAI+B,SAAS,KAAKnD,EAAE,IAAIoD,aAAa,IAAIpC,KAAK,CAACI,KAAK,GAAIiC,MAAM,GAAG,CAAE,GAAG,CAAC,EAAE;QACvErC,KAAK,CAACI,KAAK,GAAGzB,KAAK,CAACyD,aAAa,GAAGC,MAAM,EAAE,CAAC,EAAEjD,KAAK,CAACC,KAAK,CAACyB,MAAM,CAAC;MACpE,CAAC,MAAM,IAAIqB,SAAS,KAAKlD,IAAI,IAAImD,aAAa,IAAIpC,KAAK,CAACI,KAAK,GAAIiC,MAAM,GAAG,CAAE,GAAG,CAAC,EAAE;QAChFrC,KAAK,CAACI,KAAK,GAAGzB,KAAK,CAACyD,aAAa,GAAGC,MAAM,EAAE,CAAC,EAAEjD,KAAK,CAACC,KAAK,CAACyB,MAAM,GAAGlB,YAAY,CAACQ,KAAK,CAAC;MACzF;MAEA6B,aAAa,GAAG1B,MAAM,CAACH,KAAK,CAACuB,SAAS;IACxC;IAEA,SAASY,aAAaA,CAAElB,KAAa,EAAE;MACrC,IAAI,CAACd,MAAM,CAACH,KAAK,EAAE;MAEnB,MAAMoC,MAAM,GAAGlB,eAAe,CAACD,KAAK,CAAC;MACrCd,MAAM,CAACH,KAAK,CAACuB,SAAS,GAAGa,MAAM;IACjC;IAEA,MAAMC,IAAI,GAAGnE,QAAQ,CAAC,MAAM0C,IAAI,CAAC0B,GAAG,CAACtD,KAAK,CAACC,KAAK,CAACyB,MAAM,EAAEd,KAAK,CAACI,KAAK,GAAGR,YAAY,CAACQ,KAAK,CAAC,CAAC;IAC3F,MAAMuC,aAAa,GAAGrE,QAAQ,CAAC,MAAMc,KAAK,CAACC,KAAK,CAACkC,KAAK,CAACvB,KAAK,CAACI,KAAK,EAAEqC,IAAI,CAACrC,KAAK,CAAC,CAAC;IAChF,MAAMwC,UAAU,GAAGtE,QAAQ,CAAC,MAAMgD,eAAe,CAACtB,KAAK,CAACI,KAAK,CAAC,CAAC;IAC/D,MAAMyC,aAAa,GAAGvE,QAAQ,CAAC,MAAMgD,eAAe,CAAClC,KAAK,CAACC,KAAK,CAACyB,MAAM,CAAC,GAAGQ,eAAe,CAACmB,IAAI,CAACrC,KAAK,CAAC,CAAC;IAEvG,MAAM;MAAE0C;IAAgB,CAAC,GAAG3E,YAAY,CAACiB,KAAK,CAAC;IAE/Cb,SAAS,CAAC,MAAM;MACd,IAAI,CAACkB,UAAU,CAACW,KAAK,EAAE;QACrB;QACAX,UAAU,CAACW,KAAK,GAAGS,KAAK,CAACU,KAAK,CAACvB,KAAK,CAACI,KAAK,EAAEqC,IAAI,CAACrC,KAAK,CAAC,CAACoB,MAAM,CAAC,CAACC,IAAI,EAAEN,MAAM,KAAKM,IAAI,GAAGN,MAAM,EAAE,CAAC,CAAC,GAAIvB,YAAY,CAACQ,KAAM;MAC3H;IACF,CAAC,CAAC;IAEF3B,KAAK,CAAC,MAAMW,KAAK,CAACC,KAAK,CAACyB,MAAM,EAAE,MAAM;MACpCD,KAAK,GAAGhC,WAAW,CAACO,KAAK,CAACC,KAAK,CAACyB,MAAM,CAAC,CAACC,GAAG,CAAC,MAAMtB,UAAU,CAACW,KAAK,CAAC;MACnEO,OAAO,CAACoC,OAAO,CAAC,CAAC5B,MAAM,EAAE6B,IAAI,KAAK;QAChC,MAAM3B,KAAK,GAAGjC,KAAK,CAACC,KAAK,CAAC4D,OAAO,CAACD,IAAI,CAAC;QACvC,IAAI3B,KAAK,KAAK,CAAC,CAAC,EAAE;UAChBV,OAAO,CAACuC,MAAM,CAACF,IAAI,CAAC;QACtB,CAAC,MAAM;UACLnC,KAAK,CAACQ,KAAK,CAAC,GAAGF,MAAM;QACvB;MACF,CAAC,CAAC;IACJ,CAAC,CAAC;IAEFpC,SAAS,CAAC,MAAAoE,YAAA;MAAA,OAEA5C,MAAM;MAAA,SACN,kBAAkB;MAAA,YACb2B,YAAY;MAAA,SACfY,eAAe,CAAC1C;IAAK,IAAA+C,YAAA;MAAA,SAGrB,6BAA6B;MAAA,SAC5B;QACLP,UAAU,EAAEhE,aAAa,CAACgE,UAAU,CAACxC,KAAK,CAAC;QAC3CyC,aAAa,EAAEjE,aAAa,CAACiE,aAAa,CAACzC,KAAK;MAClD;IAAC,IAECuC,aAAa,CAACvC,KAAK,CAACW,GAAG,CAAC,CAACiC,IAAI,EAAE3B,KAAK,KAAA8B,YAAA,CAAAlF,kBAAA;MAAA,OAE5BoD,KAAK;MAAA,iBACK,CAACjC,KAAK,CAACK,UAAU;MAAA,mBACf0B,MAAM,IAAIC,gBAAgB,CAACC,KAAK,GAAGrB,KAAK,CAACI,KAAK,EAAEe,MAAM;IAAC;MAAA3B,OAAA,EAAAA,CAAA,MAEvEO,KAAK,CAACP,OAAO,GAAG;QAAEwD,IAAI;QAAE3B,KAAK,EAAEA,KAAK,GAAGrB,KAAK,CAACI;MAAM,CAAC,CAAC;IAAA,EAE1D,CAAC,IAGP,CAAC;IAEF,OAAO;MACLmC;IACF,CAAC;EACH;AACF,CAAC,CAAC"}